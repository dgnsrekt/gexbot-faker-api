openapi: 3.0.3
info:
  title: GEX Faker API
  version: 2.0.0
  description: |
    Historical GEX data server with per-API-key sequential playback.
    Serves JSONL data files with configurable cache modes.

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: classic
    description: Classic GEX data endpoints
  - name: state
    description: State GEX data endpoints (orderflow-based)
  - name: info
    description: Server information endpoints
  - name: admin
    description: Administrative endpoints

paths:
  /{ticker}/classic/{aggregation}/majors:
    get:
      operationId: getClassicGexMajors
      summary: Get GEX major levels
      description: |
        Provides the key GEX levels (Zero Gamma, Major Positive/Negative GEX by OI
        and Volume) from the classic GEX model. This is a slimmed-down version of
        the main GEX chain endpoint.
      tags: [classic]
      parameters:
        - name: ticker
          in: path
          required: true
          description: Ticker symbol (e.g., SPX)
          schema:
            type: string
            pattern: '^[A-Z]{1,5}$'
          example: SPX
        - name: aggregation
          in: path
          required: true
          description: "Aggregation period: full, zero, or one"
          schema:
            type: string
            enum: [full, zero, one]
          example: zero
        - name: key
          in: query
          required: true
          description: API key for playback position tracking
          schema:
            type: string
            minLength: 1
          example: test1234
      responses:
        '200':
          description: GEX major levels
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GexMajorsData'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Data not found or exhausted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /{ticker}/classic/{aggregation}/maxchange:
    get:
      operationId: getClassicGexMaxChange
      summary: Get GEX max change levels
      description: |
        Contains the strikes with the most significant GEX change over various
        lookback periods (current, 1, 5, 10, 15, and 30 minutes). Also known as "max priors".
      tags: [classic]
      parameters:
        - name: ticker
          in: path
          required: true
          description: Ticker symbol (e.g., SPX)
          schema:
            type: string
            pattern: '^[A-Z]{1,5}$'
          example: SPX
        - name: aggregation
          in: path
          required: true
          description: "Aggregation period: full, zero, or one"
          schema:
            type: string
            enum: [full, zero, one]
          example: zero
        - name: key
          in: query
          required: true
          description: API key for playback position tracking
          schema:
            type: string
            minLength: 1
          example: test1234
      responses:
        '200':
          description: GEX max change data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GexMaxChangeData'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Data not found or exhausted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /{ticker}/classic/{aggregation}:
    get:
      operationId: getClassicGexChain
      summary: Get GEX chain data
      description: |
        Provides a ladder-style histogram of GEX by Open Interest and Volume.
        Call GEX is netted against Put GEX for each strike.
        Includes historical "lookback" data points and major calculated levels.
      tags: [classic]
      parameters:
        - name: ticker
          in: path
          required: true
          description: Ticker symbol (e.g., SPX)
          schema:
            type: string
            pattern: '^[A-Z]{1,5}$'
          example: SPX
        - name: aggregation
          in: path
          required: true
          description: "Aggregation period: full, zero, or one"
          schema:
            type: string
            enum: [full, zero, one]
          example: zero
        - name: key
          in: query
          required: true
          description: API key for playback position tracking
          schema:
            type: string
            minLength: 1
          example: test1234
      responses:
        '200':
          description: GEX chain data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GexData'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Data not found or exhausted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /{ticker}/state/{type}/majors:
    get:
      operationId: getStateGexMajors
      summary: Get GEX profile major levels
      description: |
        Provides the major levels from the GEX Profile, including the strikes
        with the largest positive (call) and negative (put) GEX imbalances.
        This is a slimmed-down version of the main GEX profile endpoint.
        Only supports aggregation types (full, zero, one), not greek types.
      tags: [state]
      parameters:
        - name: ticker
          in: path
          required: true
          description: Ticker symbol (e.g., SPX)
          schema:
            type: string
            pattern: '^[A-Z]{1,5}$'
          example: SPX
        - name: type
          in: path
          required: true
          description: "Aggregation period: full, zero, or one"
          schema:
            type: string
            enum: [full, zero, one]
          example: zero
        - name: key
          in: query
          required: true
          description: API key for playback position tracking
          schema:
            type: string
            minLength: 1
          example: test1234
      responses:
        '200':
          description: GEX profile major levels
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GexMajorsData'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Data not found or exhausted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /{ticker}/state/{type}/maxchange:
    get:
      operationId: getStateGexMaxChange
      summary: Get GEX profile max change levels
      description: |
        Shows the strikes with the most significant change in GEX imbalance
        over various lookback periods (current, 1, 5, 10, 15, and 30 minutes).
        Also known as "max priors" for the GEX Profile.
        Only supports aggregation types (full, zero, one), not greek types.
      tags: [state]
      parameters:
        - name: ticker
          in: path
          required: true
          description: Ticker symbol (e.g., SPX)
          schema:
            type: string
            pattern: '^[A-Z]{1,5}$'
          example: SPX
        - name: type
          in: path
          required: true
          description: "Aggregation period: full, zero, or one"
          schema:
            type: string
            enum: [full, zero, one]
          example: zero
        - name: key
          in: query
          required: true
          description: API key for playback position tracking
          schema:
            type: string
            minLength: 1
          example: test1234
      responses:
        '200':
          description: GEX profile max change data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GexMaxChangeData'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Data not found or exhausted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /{ticker}/state/{type}:
    get:
      operationId: getStateProfile
      summary: Get state profile data (GEX or Greeks)
      description: |
        Unified endpoint for state profile data.

        When type is an aggregation (full, zero, one):
          Returns GEX profile data - nets out imbalanced calls against imbalanced puts
          to locate areas of significant imbalanced exposure.

        When type is a greek (delta_zero, gamma_zero, etc.):
          Returns Greek profile data - shows net imbalance of transactions for the
          specified Greek, allowing analysis of customer long vs. short positioning.
      tags: [state]
      parameters:
        - name: ticker
          in: path
          required: true
          description: Ticker symbol (e.g., SPX)
          schema:
            type: string
            pattern: '^[A-Z]{1,5}$'
          example: SPX
        - name: type
          in: path
          required: true
          description: "Aggregation period (full, zero, one) OR Greek type (delta_zero, gamma_zero, etc.)"
          schema:
            type: string
            enum: [full, zero, one, delta_zero, gamma_zero, delta_one, gamma_one, charm_zero, vanna_zero, charm_one, vanna_one]
          example: zero
        - name: key
          in: query
          required: true
          description: API key for playback position tracking
          schema:
            type: string
            minLength: 1
          example: test1234
      responses:
        '200':
          description: Profile data (GexData for aggregations, GreekProfileData for greeks)
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/GexData'
                  - $ref: '#/components/schemas/GreekProfileData'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Data not found or exhausted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tickers:
    get:
      operationId: getTickers
      summary: List available tickers
      tags: [info]
      responses:
        '200':
          description: Available tickers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TickersResponse'

  /health:
    get:
      operationId: getHealth
      summary: Health check
      tags: [info]
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /reset-cache:
    post:
      operationId: resetCache
      summary: Reset playback positions
      description: Reset all or specific API key playback positions to index 0
      tags: [admin]
      parameters:
        - name: key
          in: query
          required: false
          description: Reset only this API key (omit for all)
          schema:
            type: string
      responses:
        '200':
          description: Cache reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResetCacheResponse'

components:
  schemas:
    GexData:
      type: object
      required:
        - timestamp
        - ticker
      properties:
        timestamp:
          type: integer
          format: int64
          example: 1764340202
        ticker:
          type: string
          example: SPX
        min_dte:
          type: integer
          example: 0
        sec_min_dte:
          type: integer
          example: 3
        spot:
          type: number
          format: double
          example: 6822.95
        zero_gamma:
          type: number
          format: double
          example: 0
        major_pos_vol:
          type: number
          format: double
          example: 0
        major_pos_oi:
          type: number
          format: double
          example: 0
        major_neg_vol:
          type: number
          format: double
          example: 0
        major_neg_oi:
          type: number
          format: double
          example: 0
        strikes:
          type: array
          items: {}
        sum_gex_vol:
          type: number
          format: double
          example: 0
        sum_gex_oi:
          type: number
          format: double
          example: 43565.23
        delta_risk_reversal:
          type: number
          format: double
          example: 0
        max_priors:
          type: array
          items: {}

    TickersResponse:
      type: object
      properties:
        stocks:
          type: array
          items:
            type: string
          description: Array of stock ticker symbols
          example: ["AAPL", "NVDA", "TSLA"]
        indexes:
          type: array
          items:
            type: string
          description: Array of index ticker symbols
          example: ["SPX", "NDX", "VIX", "RUT"]
        futures:
          type: array
          items:
            type: string
          description: Array of futures ticker symbols
          example: ["ES_SPX", "NQ_NDX"]

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        data_date:
          type: string
          example: "2025-11-28"
        data_mode:
          type: string
          enum: [memory, stream]
          example: memory
        cache_mode:
          type: string
          enum: [exhaust, rotation]
          example: exhaust

    ResetCacheResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        message:
          type: string
          example: All cache positions reset to index 0
        count:
          type: integer
          description: Number of positions reset
          example: 12

    GexMajorsData:
      type: object
      required:
        - timestamp
        - ticker
      properties:
        timestamp:
          type: integer
          format: int64
          example: 1764340202
        ticker:
          type: string
          minLength: 2
          maxLength: 5
          example: SPX
        spot:
          type: number
          format: double
          example: 6822.95
        mpos_vol:
          type: number
          format: double
          example: 6100
        mpos_oi:
          type: number
          format: double
          example: 6100
        mneg_vol:
          type: number
          format: double
          example: 5800
        mneg_oi:
          type: number
          format: double
          example: 5800
        zero_gamma:
          type: number
          format: double
          example: 5950
        net_gex_vol:
          type: number
          format: double
          example: 12500.5
        net_gex_oi:
          type: number
          format: double
          example: 43565.23

    GexMaxChangeData:
      type: object
      required:
        - timestamp
        - ticker
      properties:
        timestamp:
          type: integer
          format: int64
          example: 1764340202
        ticker:
          type: string
          minLength: 2
          maxLength: 5
          example: SPX
        current:
          type: array
          items:
            type: number
          description: Current max GEX change [strike, gex_value]
        one:
          type: array
          items:
            type: number
          description: 1-minute lookback max GEX change
        five:
          type: array
          items:
            type: number
          description: 5-minute lookback max GEX change
        ten:
          type: array
          items:
            type: number
          description: 10-minute lookback max GEX change
        fifteen:
          type: array
          items:
            type: number
          description: 15-minute lookback max GEX change
        thirty:
          type: array
          items:
            type: number
          description: 30-minute lookback max GEX change

    GreekProfileData:
      type: object
      required:
        - timestamp
        - ticker
      properties:
        timestamp:
          type: integer
          format: int64
          example: 1764340202
        ticker:
          type: string
          minLength: 2
          maxLength: 5
          example: SPX
        spot:
          type: number
          format: double
          example: 6822.95
        min_dte:
          type: integer
          example: 0
        sec_min_dte:
          type: integer
          example: 3
        major_positive:
          type: number
          format: double
          example: 6100
        major_negative:
          type: number
          format: double
          example: 5800
        major_long_gamma:
          type: number
          format: double
          example: 6585
        major_short_gamma:
          type: number
          format: double
          example: 6585
        mini_contracts:
          type: array
          items:
            type: array
          description: Array of contract data arrays

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: Invalid ticker symbol
